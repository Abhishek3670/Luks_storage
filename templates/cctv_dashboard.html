<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CCTV Management - LUKS Web Manager</title>
    <link href="/static/css/bootstrap.min.css" rel="stylesheet">
    <link href="/static/css/bootstrap-icons.css" rel="stylesheet">
    <link href="/static/css/custom.css" rel="stylesheet">
    <style>
        .camera-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        .camera-card {
            border: 1px solid #ddd;
            border-radius: 8px;
            overflow: hidden;
            background: #fff;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .camera-header {
            background: #f8f9fa;
            padding: 12px 16px;
            border-bottom: 1px solid #ddd;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .camera-video {
            width: 100%;
            height: 280px;
            background: #000;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #666;
            position: relative;
        }
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }
        .status-online { background-color: #28a745; }
        .status-offline { background-color: #dc3545; }
        .status-connecting { background-color: #ffc107; }
        .control-panel {
            background: #f8f9fa;
            padding: 16px;
            border-top: 1px solid #ddd;
        }
        .system-status {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .recording-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-bottom: 8px;
        }
        .spinner-border-sm {
            width: 1rem;
            height: 1rem;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="/">
                <i class="bi bi-shield-lock"></i> LUKS Web Manager
            </a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="/">
                    <i class="bi bi-house"></i> Dashboard
                </a>
                <a class="nav-link active" href="/cctv">
                    <i class="bi bi-camera-video"></i> CCTV
                </a>
                <a class="nav-link" href="/admin/users">
                    <i class="bi bi-people"></i> Admin
                </a>
                <a class="nav-link" href="/logout">
                    <i class="bi bi-box-arrow-right"></i> Logout
                </a>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <!-- System Status Card -->
        <div class="system-status">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h4><i class="bi bi-camera-video"></i> CCTV System Status</h4>
                    <p class="mb-0" id="system-status-text">Loading...</p>
                </div>
                <div>
                    <button id="start-system" class="btn btn-success me-2" onclick="toggleSystem('start')" disabled>
                        <i class="bi bi-play-circle"></i> Start System
                    </button>
                    <button id="stop-system" class="btn btn-danger" onclick="toggleSystem('stop')" disabled>
                        <i class="bi bi-stop-circle"></i> Stop System
                    </button>
                </div>
            </div>
            <div class="mt-3" id="system-stats" style="display: none;">
                <div class="row text-center">
                    <div class="col-md-3">
                        <h5 id="cameras-count">0</h5>
                        <small>Cameras</small>
                    </div>
                    <div class="col-md-3">
                        <h5 id="active-streams">0</h5>
                        <small>Active Streams</small>
                    </div>
                    <div class="col-md-3">
                        <h5 id="uptime">0s</h5>
                        <small>Uptime</small>
                    </div>
                    <div class="col-md-3">
                        <h5 id="system-status">Offline</h5>
                        <small>Status</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Alert Container -->
        <div id="alert-container"></div>

        <!-- Loading Indicator -->
        <div id="loading-indicator" class="text-center" style="display: none;">
            <div class="spinner-border" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-2">Loading CCTV system...</p>
        </div>

        <!-- Tabs Navigation -->
        <ul class="nav nav-tabs" id="cctvTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="cameras-tab" data-bs-toggle="tab" data-bs-target="#cameras" type="button" role="tab">
                    <i class="bi bi-camera"></i> Live Cameras
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="recordings-tab" data-bs-toggle="tab" data-bs-target="#recordings" type="button" role="tab">
                    <i class="bi bi-collection-play"></i> Recordings
                </button>
            </li>
        </ul>

        <!-- Tab Content -->
        <div class="tab-content" id="cctvTabContent">
            <!-- Live Cameras Tab -->
            <div class="tab-pane fade show active" id="cameras" role="tabpanel">
                <div class="camera-grid" id="camera-grid">
                    <!-- Camera cards will be populated here -->
                </div>
                <div id="no-cameras" class="text-center py-5" style="display: none;">
                    <i class="bi bi-camera-video-off" style="font-size: 3rem; color: #6c757d;"></i>
                    <h4 class="mt-3">No cameras available</h4>
                    <p class="text-muted">Start the CCTV system to view cameras</p>
                </div>
            </div>

            <!-- Recordings Tab -->
            <div class="tab-pane fade" id="recordings" role="tabpanel">
                <div class="row mt-4">
                    <div class="col-md-12">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h5><i class="bi bi-collection-play"></i> Recent Recordings</h5>
                            <button class="btn btn-outline-primary" onclick="refreshRecordings()">
                                <i class="bi bi-arrow-clockwise"></i> Refresh
                            </button>
                        </div>
                        <div id="recordings-list">
                            <!-- Recordings will be populated here -->
                        </div>
                        <div id="no-recordings" class="text-center py-5" style="display: none;">
                            <i class="bi bi-collection" style="font-size: 3rem; color: #6c757d;"></i>
                            <h4 class="mt-3">No recordings found</h4>
                            <p class="text-muted">Recordings will appear here once motion is detected</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="/static/js/bootstrap.bundle.min.js"></script>
    <script>
        // Global state
        let systemRunning = false;
        let cameras = [];
        let recordings = [];
        let statusInterval;

        // Initialize the page
        document.addEventListener('DOMContentLoaded', function() {
            checkSystemStatus();
            startStatusUpdates();
        });

        // Start periodic status updates
        function startStatusUpdates() {
            statusInterval = setInterval(checkSystemStatus, 5000); // Update every 5 seconds
        }

        // Check CCTV system status
        async function checkSystemStatus() {
            try {
                const response = await fetch('/cctv/status');
                const data = await response.json();
                
                if (data.running) {
                    systemRunning = true;
                    updateSystemUI(data);
                    loadCameras();
                } else {
                    systemRunning = false;
                    updateSystemUI({running: false, message: data.message});
                }
            } catch (error) {
                console.error('Failed to check system status:', error);
                showAlert('Failed to connect to CCTV system', 'danger');
                systemRunning = false;
                updateSystemUI({running: false, message: 'Connection failed'});
            }
        }

        // Update system UI based on status
        function updateSystemUI(status) {
            const statusText = document.getElementById('system-status-text');
            const startBtn = document.getElementById('start-system');
            const stopBtn = document.getElementById('stop-system');
            const systemStats = document.getElementById('system-stats');

            if (status.running) {
                statusText.textContent = 'System Online - All cameras operational';
                startBtn.disabled = true;
                stopBtn.disabled = false;
                systemStats.style.display = 'block';
                
                // Update stats
                document.getElementById('cameras-count').textContent = status.cameras_count || 0;
                document.getElementById('active-streams').textContent = status.active_streams || 0;
                document.getElementById('uptime').textContent = formatUptime(status.uptime_seconds || 0);
                document.getElementById('system-status').textContent = 'Online';
            } else {
                statusText.textContent = status.message || 'System Offline';
                startBtn.disabled = false;
                stopBtn.disabled = true;
                systemStats.style.display = 'none';
                
                // Clear cameras when offline
                document.getElementById('camera-grid').innerHTML = '';
                document.getElementById('no-cameras').style.display = 'block';
            }
        }

        // Toggle system start/stop
        async function toggleSystem(action) {
            const loadingIndicator = document.getElementById('loading-indicator');
            const startBtn = document.getElementById('start-system');
            const stopBtn = document.getElementById('stop-system');
            
            // Show loading
            loadingIndicator.style.display = 'block';
            startBtn.disabled = true;
            stopBtn.disabled = true;
            
            try {
                const response = await fetch(`/cctv/${action}`, { method: 'POST' });
                const data = await response.json();
                
                if (data.success) {
                    showAlert(data.message, 'success');
                    checkSystemStatus(); // Refresh status
                } else {
                    showAlert(data.error || 'Operation failed', 'danger');
                }
            } catch (error) {
                console.error(`Failed to ${action} system:`, error);
                showAlert(`Failed to ${action} CCTV system`, 'danger');
            } finally {
                loadingIndicator.style.display = 'none';
                // Re-enable buttons based on status
                setTimeout(checkSystemStatus, 1000);
            }
        }

        // Load cameras list
        async function loadCameras() {
            try {
                const response = await fetch('/cctv/cameras');
                cameras = await response.json();
                renderCameras();
            } catch (error) {
                console.error('Failed to load cameras:', error);
                showAlert('Failed to load camera list', 'warning');
            }
        }

        // Render cameras in the grid
        function renderCameras() {
            const cameraGrid = document.getElementById('camera-grid');
            const noCameras = document.getElementById('no-cameras');
            
            if (cameras.length === 0) {
                cameraGrid.innerHTML = '';
                noCameras.style.display = 'block';
                return;
            }
            
            noCameras.style.display = 'none';
            cameraGrid.innerHTML = cameras.map(camera => `
                <div class="camera-card">
                    <div class="camera-header">
                        <div>
                            <strong>${camera.name}</strong>
                            <span class="status-indicator status-${camera.status === 'connected' ? 'online' : 'offline'}"></span>
                            <small class="text-muted">${camera.status || 'unknown'}</small>
                        </div>
                        <small class="text-muted">${camera.id}</small>
                    </div>
                    <div class="camera-video" id="camera-${camera.id}">
                        ${camera.status === 'connected' ? 
                            `<img src="/cctv/stream/${camera.id}" alt="${camera.name}" style="width: 100%; height: 100%; object-fit: cover;" 
                                 onerror="this.style.display='none'; this.parentNode.innerHTML='<i class=\\"bi bi-exclamation-triangle\\"></i><br>Stream not available';">` :
                            `<i class="bi bi-camera-video-off"></i><br>Camera offline`
                        }
                    </div>
                    <div class="control-panel">
                        <button class="btn btn-sm btn-outline-primary me-2" onclick="refreshCamera('${camera.id}')">
                            <i class="bi bi-arrow-clockwise"></i> Refresh
                        </button>
                        <button class="btn btn-sm btn-outline-info" onclick="openFullscreen('${camera.id}')">
                            <i class="bi bi-fullscreen"></i> Fullscreen
                        </button>
                    </div>
                </div>
            `).join('');
        }

        // Refresh individual camera
        function refreshCamera(cameraId) {
            const cameraElement = document.getElementById(`camera-${cameraId}`);
            const img = cameraElement.querySelector('img');
            if (img) {
                img.src = `/cctv/stream/${cameraId}?t=${Date.now()}`;
            }
        }

        // Open camera in fullscreen
        function openFullscreen(cameraId) {
            const camera = cameras.find(c => c.id === cameraId);
            if (camera) {
                window.open(`/cctv/stream/${cameraId}`, '_blank');
            }
        }

        // Load recordings
        async function loadRecordings() {
            try {
                const response = await fetch('/cctv/recordings');
                recordings = await response.json();
                renderRecordings();
            } catch (error) {
                console.error('Failed to load recordings:', error);
                showAlert('Failed to load recordings', 'warning');
            }
        }

        // Render recordings list
        function renderRecordings() {
            const recordingsList = document.getElementById('recordings-list');
            const noRecordings = document.getElementById('no-recordings');
            
            if (recordings.length === 0) {
                recordingsList.innerHTML = '';
                noRecordings.style.display = 'block';
                return;
            }
            
            noRecordings.style.display = 'none';
            recordingsList.innerHTML = recordings.map(recording => `
                <div class="recording-item">
                    <div>
                        <strong>${recording.filename}</strong><br>
                        <small class="text-muted">
                            Camera: ${recording.camera_id} | 
                            ${recording.timestamp} | 
                            Size: ${formatFileSize(recording.size_bytes)}
                            ${recording.duration_seconds ? ` | Duration: ${recording.duration_seconds}s` : ''}
                        </small>
                    </div>
                    <div>
                        <button class="btn btn-sm btn-outline-primary" onclick="downloadRecording('${recording.filename}')">
                            <i class="bi bi-download"></i> Download
                        </button>
                    </div>
                </div>
            `).join('');
        }

        // Refresh recordings
        function refreshRecordings() {
            loadRecordings();
        }

        // Download recording
        function downloadRecording(filename) {
            window.open(`/cctv/recording/${filename}`, '_blank');
        }

        // Tab change handler
        document.getElementById('recordings-tab').addEventListener('click', function() {
            if (systemRunning) {
                loadRecordings();
            }
        });

        // Utility functions
        function formatUptime(seconds) {
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            const secs = seconds % 60;
            return hours > 0 ? `${hours}h ${minutes}m` : `${minutes}m ${secs}s`;
        }

        function formatFileSize(bytes) {
            const sizes = ['B', 'KB', 'MB', 'GB'];
            if (bytes === 0) return '0 B';
            const i = Math.floor(Math.log(bytes) / Math.log(1024));
            return `${(bytes / Math.pow(1024, i)).toFixed(1)} ${sizes[i]}`;
        }

        // Show alert message
        function showAlert(message, type = 'info') {
            const alertContainer = document.getElementById('alert-container');
            const alertId = 'alert-' + Date.now();
            const alert = `
                <div id="${alertId}" class="alert alert-${type} alert-dismissible fade show" role="alert">
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;
            alertContainer.innerHTML = alert;
            
            // Auto-dismiss after 5 seconds
            setTimeout(() => {
                const alertElement = document.getElementById(alertId);
                if (alertElement) {
                    alertElement.remove();
                }
            }, 5000);
        }

        // Cleanup on page unload
        window.addEventListener('beforeunload', function() {
            if (statusInterval) {
                clearInterval(statusInterval);
            }
        });
    </script>
</body>
</html>
