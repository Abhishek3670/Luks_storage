{% extends "base.html" %}

{% block title %}Camera Settings Management{% endblock %}

{% block content %}
<div class="d-flex flex-column flex-md-row">
    <!-- Sidebar -->
    <div class="sidebar border-end bg-light p-3" style="min-width: 280px;">
        <h5 class="mb-3">Admin Menu</h5>
        <ul class="nav nav-pills flex-column">
            <li class="nav-item">
              <a href="/admin/users" class="nav-link">
                <i class="bi bi-people me-2"></i>Users
              </a>
            </li>
            <li class="nav-item">
              <a href="/admin/permissions" class="nav-link">
                <i class="bi bi-shield-check me-2"></i>Permissions
              </a>
            </li>
            <li class="nav-item">
              <a href="/admin/camera-settings" class="nav-link active" aria-current="page">
                <i class="bi bi-camera me-2"></i>Camera Settings
              </a>
            </li>
            <li class="nav-item">
              <a href="/admin/server-health" class="nav-link">
                <i class="bi bi-activity me-2"></i>Server Health
              </a>
            </li>
        </ul>
    </div>

    <!-- Main Content -->
    <div class="main-content flex-grow-1 p-3">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h2 class="h4">Camera Configuration</h2>
            <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addCameraModal">
                <i class="bi bi-camera-video"></i> Add Camera
            </button>
        </div>

        <!-- Flash Messages -->
        {% for message in messages %}
        <div class="alert alert-{{ message.level | lower }} alert-dismissible fade show" role="alert">
            {{ message.content }}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
        {% endfor %}

        <!-- Camera Settings Table -->
        <div class="card shadow-sm">
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>Camera Name</th>
                                <th>IP Address</th>
                                <th>Status</th>
                                <th>Resolution</th>
                                <th>FPS</th>
                                <th>Recording</th>
                                <th>Motion Detection</th>
                                <th>Last Updated</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% if cameras | length == 0 %}
                            <tr>
                                <td colspan="9" class="text-center text-muted">No cameras configured.</td>
                            </tr>
                            {% else %}
                            {% for camera in cameras %}
                            <tr>
                                <td>
                                    <strong>{{ camera.name }}</strong>
                                    <br><small class="text-muted">{{ camera.location }}</small>
                                </td>
                                <td>
                                    <code>{{ camera.ip_address }}</code>
                                    <br><small class="text-muted">Port: {{ camera.port }}</small>
                                </td>
                                <td>
                                    {% if camera.is_online %}
                                        <span class="badge bg-success"><i class="bi bi-circle-fill"></i> Online</span>
                                    {% else %}
                                        <span class="badge bg-danger"><i class="bi bi-circle-fill"></i> Offline</span>
                                    {% endif %}
                                </td>
                                <td>{{ camera.resolution }}</td>
                                <td>{{ camera.fps }}</td>
                                <td>
                                    {% if camera.recording_enabled %}
                                        <span class="badge bg-success"><i class="bi bi-record-circle"></i> On</span>
                                    {% else %}
                                        <span class="badge bg-secondary"><i class="bi bi-stop-circle"></i> Off</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if camera.motion_detection %}
                                        <span class="badge bg-info"><i class="bi bi-eye"></i> Active</span>
                                    {% else %}
                                        <span class="badge bg-secondary"><i class="bi bi-eye-slash"></i> Inactive</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <small class="text-muted">{{ camera.updated_at }}</small>
                                </td>
                                <td>
                                    <div class="btn-group" role="group">
                                        <button type="button" class="btn btn-sm btn-outline-primary" 
                                                onclick="editCamera('{{ camera.id }}')" 
                                                data-bs-toggle="modal" 
                                                data-bs-target="#editCameraModal">
                                            <i class="bi bi-pencil"></i>
                                        </button>
                                        <button type="button" class="btn btn-sm btn-outline-success" 
                                                onclick="viewCamera('{{ camera.id }}')">
                                            <i class="bi bi-eye"></i>
                                        </button>
                                        <form action="/admin/camera-settings/delete" method="POST" class="d-inline" 
                                              onsubmit="return confirm('Are you sure you want to delete camera {{ camera.name }}?');">
                                            <input type="hidden" name="camera_id" value="{{ camera.id }}">
                                            <button type="submit" class="btn btn-sm btn-outline-danger">
                                                <i class="bi bi-trash"></i>
                                            </button>
                                        </form>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                            {% endif %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add Camera Modal -->
<div class="modal fade" id="addCameraModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add New Camera</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form action="/admin/camera-settings/add" method="POST">
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="camera_name" class="form-label">Camera Name *</label>
                                <input type="text" class="form-control" id="camera_name" name="camera_name" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="location" class="form-label">Location</label>
                                <input type="text" class="form-control" id="location" name="location" 
                                       placeholder="e.g., Front Door, Living Room">
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-8">
                            <div class="mb-3">
                                <label for="ip_address" class="form-label">IP Address *</label>
                                <input type="text" class="form-control" id="ip_address" name="ip_address" 
                                       pattern="^(?:[0-9]{1,3}\.){3}[0-9]{1,3}$" 
                                       placeholder="192.168.1.100" required>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="port" class="form-label">Port</label>
                                <input type="number" class="form-control" id="port" name="port" 
                                       min="1" max="65535" value="554">
                            </div>  
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="username" class="form-label">Username</label>
                                <input type="text" class="form-control" id="username" name="username">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="password" class="form-label">Password</label>
                                <input type="password" class="form-control" id="password" name="password">
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="resolution" class="form-label">Resolution</label>
                                <select class="form-select" id="resolution" name="resolution">
                                    <option value="1920x1080">1920x1080 (Full HD)</option>
                                    <option value="1280x720">1280x720 (HD)</option>
                                    <option value="640x480">640x480 (VGA)</option>
                                    <option value="custom">Custom</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="fps" class="form-label">Frame Rate (FPS)</label>
                                <select class="form-select" id="fps" name="fps">
                                    <option value="30">30 FPS</option>
                                    <option value="25">25 FPS</option>
                                    <option value="15">15 FPS</option>
                                    <option value="10">10 FPS</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="alert alert-info">
                        <i class="bi bi-info-circle me-2"></i>
                        <strong>Note:</strong> Camera settings will be applied after saving. Make sure the camera is accessible on the network.
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="recording_enabled" name="recording_enabled" value="true" checked>
                                <label class="form-check-label" for="recording_enabled">
                                    Enable Recording
                                </label>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="motion_detection" name="motion_detection" value="true">
                                <label class="form-check-label" for="motion_detection">
                                    Motion Detection
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Add Camera</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Edit Camera Modal -->
<div class="modal fade" id="editCameraModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edit Camera Settings</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form action="/admin/camera-settings/edit" method="POST" id="editCameraForm">
                <input type="hidden" name="camera_id" id="edit_camera_id">
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="edit_camera_name" class="form-label">Camera Name *</label>
                                <input type="text" class="form-control" id="edit_camera_name" name="camera_name" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="edit_location" class="form-label">Location</label>
                                <input type="text" class="form-control" id="edit_location" name="location">
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-8">
                            <div class="mb-3">
                                <label for="edit_ip_address" class="form-label">IP Address *</label>
                                <input type="text" class="form-control" id="edit_ip_address" name="ip_address" required>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="edit_port" class="form-label">Port</label>
                                <input type="number" class="form-control" id="edit_port" name="port">
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="edit_recording_enabled" name="recording_enabled" value="true">
                                <label class="form-check-label" for="edit_recording_enabled">
                                    Enable Recording
                                </label>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="edit_motion_detection" name="motion_detection" value="true">
                                <label class="form-check-label" for="edit_motion_detection">
                                    Motion Detection
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Update Camera</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
// Handle checkbox values for form submission
document.addEventListener('DOMContentLoaded', function() {
    const forms = document.querySelectorAll('form');
    
    forms.forEach(form => {
        const checkboxes = form.querySelectorAll('input[type="checkbox"]');
        
        checkboxes.forEach(checkbox => {
            // Handle checkbox changes to ensure proper form submission
            checkbox.addEventListener('change', function() {
                const hiddenInput = form.querySelector(`input[type="hidden"][name="${this.name}"]`);
                
                if (!this.checked) {
                    if (!hiddenInput) {
                        const hidden = document.createElement('input');
                        hidden.type = 'hidden';
                        hidden.name = this.name;
                        hidden.value = 'false';
                        this.parentNode.appendChild(hidden);
                    }
                } else {
                    if (hiddenInput) {
                        hiddenInput.remove();
                    }
                }
            });
        });
    });
});

// Edit camera function
function editCamera(cameraId) {
    // This would typically fetch camera data via AJAX
    // For now, it's a placeholder for the edit functionality
    document.getElementById('edit_camera_id').value = cameraId;
    
    // In a real application, you would fetch camera data here:
    // fetch(`/admin/camera-settings/${cameraId}`)
    //     .then(response => response.json())
    //     .then(data => {
    //         document.getElementById('edit_camera_name').value = data.name;
    //         document.getElementById('edit_location').value = data.location;
    //         document.getElementById('edit_ip_address').value = data.ip_address;
    //         document.getElementById('edit_port').value = data.port;
    //         document.getElementById('edit_recording_enabled').checked = data.recording_enabled;
    //         document.getElementById('edit_motion_detection').checked = data.motion_detection;
    //     });
}

// View camera function
function viewCamera(cameraId) {
    // Redirect to camera view or open live stream
    window.open(`/camera/view/${cameraId}`, '_blank');
}

// Test camera connection
function testConnection(cameraId) {
    // This would test the camera connection
    fetch(`/admin/camera-settings/test/${cameraId}`, {
        method: 'POST'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Camera connection successful!');
        } else {
            alert('Camera connection failed: ' + data.error);
        }
    })
    .catch(error => {
        alert('Error testing connection: ' + error);
    });
}
</script>
{% endblock %}
